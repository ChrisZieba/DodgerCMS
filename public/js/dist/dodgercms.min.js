/*! dodgercms 0.0.1 2015-05-09 */
var dodgercms=dodgercms||{};dodgercms.auth=function(){"use strict";function login(params,callback){if(1===arguments.length){if(callback=params,params=getCredentials(!0),!params)return callback("Could not login due to lack of user credentials.");params.remember=!0}for(var required=["dataBucket","assetsBucket","siteBucket","accessKey","accessSecret"],i=0;i<required.length;i+=1)if(!params.hasOwnProperty(required[i])&&params[required[i]])return callback(required[i]+" is a required field.");params.remember=params.hasOwnProperty("remember")?Boolean(params.remember):!1;var sts=new AWS.STS({accessKeyId:params.accessKey,secretAccessKey:params.accessSecret,sslEnabled:!0,apiVersion:"2011-06-15"}),policy=getPolicy(params.dataBucket,params.assetsBucket,params.siteBucket),stsParams={Name:"dodgercms-buckets-policy",Policy:policy,DurationSeconds:129600};sts.getFederationToken(stsParams,function(err,data){if(err)return callback("Access Denied. Please make sure the acccess key and secret are correct and try again.");var s3=new AWS.S3({accessKeyId:data.Credentials.AccessKeyId,secretAccessKey:data.Credentials.SecretAccessKey,sessionToken:data.Credentials.SessionToken,sslEnabled:!0});async.each([params.dataBucket,params.assetsBucket],function(bucket,cb){s3.headBucket({Bucket:bucket},function(err){err?cb("Access Denied. Please make sure the user attached to the access key has access to "+bucket+"."):cb()})},function(err){return err?callback(err):void async.parallel([function(cb1){s3.getBucketWebsite({Bucket:params.siteBucket},function(err,websiteData){err?cb1("Access Denied. Please make sure the user attached to the access key has access to "+params.siteBucket+"."):cb1(null,websiteData)})},function(cb1){s3.getBucketLocation({Bucket:params.siteBucket},function(err,locationData){err?cb1("Access Denied. Please make sure the user attached to the access key has access to "+params.siteBucket+"."):cb1(null,locationData)})}],function(err,results){if(err)callback(err);else{var location=results[1],locationConstraint=location.hasOwnProperty("LocationConstraint")?location.LocationConstraint:"",endpoint=getEndpoint("http://",params.siteBucket,locationConstraint);sessionStorage.setItem("dodgercms-token-access-key-id",data.Credentials.AccessKeyId),sessionStorage.setItem("dodgercms-token-secret-access-key",data.Credentials.SecretAccessKey),sessionStorage.setItem("dodgercms-token-session-token",data.Credentials.SessionToken),params.remember&&(localStorage.setItem("dodgercms-access-key-id",params.accessKey),localStorage.setItem("dodgercms-secret-access-key",params.accessSecret)),localStorage.setItem("dodgercms-data-bucket",params.dataBucket),localStorage.setItem("dodgercms-assets-bucket",params.assetsBucket),localStorage.setItem("dodgercms-site-bucket",params.siteBucket),localStorage.setItem("dodgercms-site-endpoint",endpoint),callback(null,data)}})})})}function logout(){localStorage.removeItem("dodgercms-access-key-id"),localStorage.removeItem("dodgercms-secret-access-key"),localStorage.removeItem("dodgercms-data-bucket"),localStorage.removeItem("dodgercms-assets-bucket"),localStorage.removeItem("dodgercms-site-bucket"),localStorage.removeItem("dodgercms-site-endpoint"),redirect()}function redirect(uri){uri||(uri=location.protocol+"//"+location.host+"/login"),window.location.replace(uri)}var getCredentials=function(allOrNothing){var credentials={dataBucket:localStorage.getItem("dodgercms-data-bucket"),assetsBucket:localStorage.getItem("dodgercms-assets-bucket"),siteBucket:localStorage.getItem("dodgercms-site-bucket"),accessKey:localStorage.getItem("dodgercms-access-key-id"),accessSecret:localStorage.getItem("dodgercms-secret-access-key")};if(allOrNothing)for(var property in credentials)if(credentials.hasOwnProperty(property)&&!credentials[property])return null;return credentials},getEndpoint=function(protocol,bucket,location){""===location?location="us-east-1":"EU"===location&&(location="eu-west-1");var endpoint=protocol+bucket+".s3-website-"+location+".amazonaws.com/";return endpoint},getPolicy=function(dataBucket,assetsBucket,siteBucket){var policy='{"Version": "2012-10-17","Statement": [{"Sid": "Stmt1427944232000","Effect": "Allow","Action": ["s3:ListBucket","s3:GetObject","s3:DeleteObject","s3:PutObject","s3:GetBucketWebsite","s3:PutBucketWebsite","s3:DeleteBucketWebsite","s3:GetBucketLogging","s3:GetBucketVersioning","s3:GetBucketLocation"],"Resource": ["arn:aws:s3:::'+dataBucket+'","arn:aws:s3:::'+dataBucket+'/*","arn:aws:s3:::'+assetsBucket+'","arn:aws:s3:::'+assetsBucket+'/*","arn:aws:s3:::'+siteBucket+'","arn:aws:s3:::'+siteBucket+'/*"]}]}';return policy};return{login:login,logout:logout,redirect:redirect}}();var dodgercms=dodgercms||{};dodgercms.entry=function(){"use strict";function remove(key,dataBucket,siteBucket,callback){dodgercms.s3.deleteObjects(key,dataBucket,function(err,data){err?callback(err):dodgercms.s3.deleteObjects(key,siteBucket,function(err,data){err?callback(err):callback(null,data)})})}function rename(source,target,dataBucket,siteBucket,callback){dodgercms.s3.renameObjects(source,target,dataBucket,function(err,data){err?callback(err):dodgercms.s3.renameObjects(source,target,siteBucket,function(err,data){err?callback(err):remove(source,dataBucket,siteBucket,callback)})})}function upsert(key,title,content,bucket,endpoint,callback){async.waterfall([function(waterfallCb){var options={renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!0,highlight:function(code){return hljs.highlightAuto(code).value}};marked(content,options,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})},function(body,waterfallCb){var modified=new Date,context={key:key,title:title,modified:modified.toLocaleString(),body:body,bucket:bucket,endpoint:endpoint,dataKey:DATA_KEY},entry=dodgercms.templates["entry.html"],html=entry(context);waterfallCb(null,html)},function(html,waterfallCb){var params={Bucket:bucket,Key:key,Body:html,ContentType:"text/html; charset=UTF-8",Expires:0,CacheControl:"public, max-age=0, no-cache",Metadata:{title:title}};dodgercms.s3.upload(params,function(err,data){waterfallCb(err?err:null)})}],function(err,result){err?callback(err):callback(null,result)})}function menu(bucket,endpoint,callback){async.waterfall([function(waterfallCb){dodgercms.s3.listObjects(null,bucket,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})},function(data,waterfallCb){for(var contents=data.Contents,i=contents.length-1;i>=0;i-=1)"."===contents[i].Key.substr(0,1)&&contents.splice(i,1);waterfallCb(null,contents)},function(data,waterfallCb){var keys=[];async.each(data,function(object,cb){dodgercms.s3.headObject(object.Key,bucket,function(err,objectData){err?cb(err):(objectData.Key=object.Key,keys.push(objectData),cb(null))})},function(err){err?waterfallCb(err):waterfallCb(null,keys)})},function(keys,waterfallCb){function buildFromSegments(scope,parentScope,keyParts,pathSegments,isFolder,keyLabel){var current=pathSegments.shift();keyParts.push(current);var label=current,found=findInScope(scope,current);if(found)!pathSegments.length&&isFolder&&keyLabel&&(found.label=keyLabel);else{var key=keyParts.join("/");pathSegments.length?key+="/":(isFolder&&(key+="/"),keyLabel&&(label=keyLabel)),found={key:key,part:current,index:pathSegments.length||"index"!==current?!1:!0,link:isFolder?null:key,label:label,children:!1},parentScope&&isFolder&&"index"===current&&(parentScope.link=parentScope.key),scope.push(found)}pathSegments.length&&(found.children=found.children||[],buildFromSegments(found.children,found,keyParts,pathSegments,isFolder,keyLabel))}function findInScope(scope,find){for(var i=0;i<scope.length;i++)if(scope[i].part===find)return scope[i]}var tree=[];keys.forEach(function(object){var key=object.Key,isFolder="/"===key.substr(-1)?!0:!1,label=isFolder?object.Metadata.label:object.Metadata.title,parts=object.Key.replace(/\/\s*$/,"").split("/");buildFromSegments(tree,null,[],parts,isFolder,label)}),waterfallCb(null,tree)},function(data,waterfallCb){var params={Bucket:bucket,Key:DATA_KEY,Body:JSON.stringify(data),ContentType:"application/json; charset=UTF-8",Expires:0,CacheControl:"public, max-age=0, no-cache"};dodgercms.s3.upload(params,function(err,data){err?waterfallCb(err):waterfallCb(null,data)})}],function(err,result){err?callback(err):callback(null,result)})}var DATA_KEY=".dodgercms/data.json";return{upsert:upsert,remove:remove,rename:rename,menu:menu}}();var dodgercms=dodgercms||{};dodgercms.s3=function(){"use strict";function init(accessKeyId,secretAccessKey,sessionToken,force){if(!accessKeyId||!secretAccessKey||!sessionToken)throw"Missing Arguments";return(!s3||force)&&(s3=new AWS.S3({accessKeyId:accessKeyId,secretAccessKey:secretAccessKey,sessionToken:sessionToken,sslEnabled:!0,DurationSeconds:129600,apiVersion:API_VERSION,maxRetries:1})),s3}function getApiVersion(){return API_VERSION}function renameObject(source,target,bucket,callback){var params={Bucket:bucket,MetadataDirective:"COPY",CopySource:bucket+"/"+source,Key:target};s3.copyObject(params,function(err,data){err?callback(err):deleteObject(source,bucket,callback)})}function upload(params,callback){s3.upload(params,function(err,data){err?callback(err):callback(null,data)})}function getObject(key,bucket,callback){var params={Bucket:bucket,Key:key};s3.getObject(params,function(err,data){err?callback(err):callback(null,data)})}function headObject(key,bucket,callback){var params={Bucket:bucket,Key:key};s3.headObject(params,function(err,data){err?callback(err):callback(null,data)})}function putObject(key,bucket,callback){var params;2===arguments.length&&"object"==typeof key?(params=key,callback=bucket):params={Bucket:bucket,Key:key},s3.putObject(params,function(err,data){err?callback(err):callback(null,data)})}function deleteObject(key,bucket,callback){var params={Bucket:bucket,Key:key};s3.deleteObject(params,function(err,data){err&&"NoSuckKey"!==err.code?callback(err):callback(null,data)})}function copyObject(source,target,bucket,callback){var params={Bucket:bucket,MetadataDirective:"COPY",CopySource:bucket+"/"+source,Key:target};s3.copyObject(params,function(err,data){err?callback(err):callback(null,data)})}function renameObjects(source,target,bucket,callback){if("/"===source.substr(-1)){var parts=source.replace(/\/\s*$/,"").split("/");parts.splice(-1,1,target);var targetPrefix=parts.join("/")+"/";listObjects(source,bucket,function(err,data){if(err)callback(err);else{var contents=data.Contents;async.each(contents,function(object,cb){var key=targetPrefix+object.Key.substr(source.length);dodgercms.s3.copyObject(object.Key,key,bucket,cb)},function(err){callback(err?err:null)})}})}else dodgercms.s3.copyObject(source,target,bucket,callback)}function deleteObjects(key,bucket,callback){"/"===key.substr(-1)?listObjects(key,bucket,function(err,data){if(err);else{var contents=data.Contents;async.each(contents,function(object,cb){dodgercms.s3.deleteObject(object.Key,bucket,cb)},function(err){callback(err?err:null)})}}):dodgercms.s3.deleteObject(key,bucket,callback)}function listObjects(prefix,bucket,callback){2===arguments.length&&(callback=bucket,bucket=prefix,prefix="");var params={Bucket:bucket,EncodingType:ENCODING_TYPE,MaxKeys:1e3,Prefix:prefix};s3.listObjects(params,function(err,data){err?callback(err):callback(null,data)})}function headObjects(contents,bucket,callback){var keys=[];async.each(contents,function(object,cb){s3.headObject({Bucket:bucket,Key:object.Key},function(err,data){err?cb(err):(data.Key=object.Key,keys.push(data),cb(null))})},function(err){err?callback(err):callback(null,keys)})}var ENCODING_TYPE="url",API_VERSION="2011-06-15",s3=null;return{init:init,getApiVersion:getApiVersion,getObject:getObject,upload:upload,headObject:headObject,putObject:putObject,copyObject:copyObject,deleteObject:deleteObject,deleteObjects:deleteObjects,renameObject:renameObject,renameObjects:renameObjects,listObjects:listObjects,headObjects:headObjects}}();var dodgercms=dodgercms||{};dodgercms.utils=function(){"use strict";function getFolders(objects){for(var folders=["/"],i=0;i<objects.length;i+=1)for(var key=objects[i].Key,parts=key.replace(/\/\s*$/,"").split("/"),j=0;j<parts.length;j+=1){var isFolder=!1;if((j===parts.length-1&&"/"===key.substr(-1)||j!==parts.length-1)&&(isFolder=!0),isFolder){var folder=parts.slice(0,j+1).join("/")+"/";$.inArray(folder,folders)<0&&folders.push(folder)}}return folders}function newFolder(key,dataBucket,siteBucket,callback){dodgercms.s3.putObject(key,dataBucket,function(err,data){err?callback(err):dodgercms.s3.putObject(key,siteBucket,function(err,data){err?callback(err):"undefined"!=typeof callback&&callback(null,key)})})}return{newFolder:newFolder,getFolders:getFolders}}(),$(function(){"use strict";function s3init(force){var accessKeyId=sessionStorage.getItem("dodgercms-token-access-key-id"),secretAccessKey=sessionStorage.getItem("dodgercms-token-secret-access-key"),sessionToken=sessionStorage.getItem("dodgercms-token-session-token");dodgercms.s3.init(accessKeyId,secretAccessKey,sessionToken,force)}function errorHandler(err){var code=err.code;"ExpiredToken"===code&&($.blockUI(),dodgercms.auth.login(function(err,data){$.unblockUI(),err?dodgercms.auth.redirect():(s3init(!0),rebuildTree())}))}function rebuildTree(){$("#tree").jstree("destroy"),$("#list").empty().html('<div id="tree" class="tree""></div>'),buildTree()}function buildTree(){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){err?errorHandler(err):dodgercms.s3.headObjects(data.Contents,DATA_BUCKET,function(err,data){var $tree=$("#tree"),tree=[];tree.push({id:"s3--root",parent:"#",text:'<span class="bucket">'+DATA_BUCKET+"</span>",type:"folder",a_attr:{title:DATA_BUCKET},li_attr:{"data-key":"/"},state:{opened:!0}});for(var searchFn=function(e){return e.id===search},i=0;i<data.length;i+=1){var object=data[i],key=object.Key;if("/"===key.substr(-1)||object.ContentType===CONTENT_TYPE)for(var parts=key.replace(/\/\s*$/,"").split("/"),j=0;j<parts.length;j+=1){var isFolder=!1;(j===parts.length-1&&"/"===key.substr(-1)||j!==parts.length-1)&&(isFolder=!0);var search="s3-"+(j>0?parts.slice(0,j+1).join("-"):parts[j]);isFolder&&(search+="-folder");var result=$.grep(tree,searchFn);if(result.length)parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(result[0].li_attr["data-label"]=object.Metadata.label);else{var parent=j>0?"s3-"+parts.slice(0,j).join("-"):"s3--root";"s3--root"!==parent&&(parent+="-folder");var node={id:search,parent:parent,text:parts[j],type:isFolder?"folder":"file",a_attr:{},state:{opened:!0}};isFolder?(node.li_attr={"data-key":j>0?parts.slice(0,j+1).join("/")+"/":parts[j]+"/"},parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(node.li_attr["data-label"]=object.Metadata.label,node.a_attr.title=object.Metadata.label)):(parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.title&&(node.a_attr.title=object.Metadata.title),"index"===parts[j]&&(node.type="index"),node.li_attr={"data-key":key}),tree.push(node)}}}var onTreeChange=function(event,data){var action=data.action;switch(action){case"select_node":if("folder"!==data.node.type){var key=data.node.li_attr["data-key"];getKeyContent(key),$("#main").data("key",key)}}},customMenu=function(node){var newFolder=function(elem){for(var input="",key=node.li_attr["data-key"];!/^([a-zA-Z0-9-_]){1,32}$/.test(input);){if(input=window.prompt("Enter the name of the new folder."),null===input)return;input=input.toLowerCase()}if("folder"===node.type){var newKey="/"===key?input+"/":key+input+"/";dodgercms.utils.newFolder(newKey,DATA_BUCKET,SITE_BUCKET,function(err,data){addNode(newKey,key,input)})}},renameItem=function(elem){var msg,key=node.li_attr["data-key"],parts=key.replace(/\/\s*$/,"").split("/"),last=parts[parts.length-1],input=last;do{if(msg="folder"===node.type?"Enter the new name for folder: "+input:"Enter the new name for entry: "+input,input=window.prompt(msg,input),null===input)return;input=input.toLowerCase()}while(!/^([a-zA-Z0-9-_]){1,32}$/.test(input));if(input!==last){block();var target=input;"folder"!==node.type&&(parts.splice(-1,1,input),target=parts.join("/")),dodgercms.entry.rename(key,target,DATA_BUCKET,SITE_BUCKET,function(err,data){unblock(),err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){err?errorHandler(err):(rebuildTree(),$("#main").data("key",key))})})}},editLabel=function(elem){var input,msg,label=node.li_attr["data-label"],key=node.li_attr["data-key"];do if(msg=label?"Enter the name of the new label for the directory: "+key:"Enter the label (used for the frontend menu) for the directory: "+key,input=label?window.prompt(msg,label):window.prompt(msg),null===input)return;while(!/^([\w-_\.\s\(\)\/\\]){1,32}$/.test(input));if(input!==label){var params={Bucket:DATA_BUCKET,Key:key,Metadata:{label:input}};dodgercms.s3.putObject(params,function(err,data){err?errorHandler(err):(params.Bucket=SITE_BUCKET,dodgercms.s3.putObject(params,function(err,data){err&&errorHandler(err)}))})}},editItem=function(elem){var key=node.li_attr["data-key"];editEntry(key)},removeItem=function(elem){var input=window.confirm("Are you sure?");if(null!==input){var key=node.li_attr["data-key"];dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){clearEntry(key),$tree.jstree("delete_node","#"+node.id)})})}},newItem=function(elem){var key=node.li_attr["data-key"];"folder"===node.type&&newEntry(key)},items={editLabel:{},newEntry:{label:"New Entry",action:newItem},editEntry:{label:"Edit",action:editItem},newFolder:{label:"New Folder",separator_after:!0,action:newFolder},renameItem:{label:"Rename",action:renameItem},removeItem:{label:"Delete",action:removeItem}};if("folder"===node.type){var label=node.li_attr["data-label"],labelText=label?"Edit Label":"Add Label";items.editLabel={label:labelText,separator_after:!0,action:editLabel},delete items.editEntry}else items.newEntry._disabled=!0,items.newFolder._disabled=!0,delete items.editLabel;return"s3--root"===node.id&&(items.removeItem._disabled=!0,items.renameItem._disabled=!0,items.editLabel._disabled=!0),items};$tree.on("changed.jstree",onTreeChange).jstree({core:{check_callback:!0,themes:{dots:!0,name:"proton",responsive:!1},animation:!1,data:tree},types:{"default":{icon:"fa"},file:{icon:"fa fa-file-text-o"},index:{icon:"fa fa-asterisk"},folder:{icon:"fa fa-folder-o",select_node:!1}},plugins:["unique","contextmenu","sort","ui","types"],contextmenu:{items:customMenu,select_node:!1},sort:function(a,b){var nodeA=this.get_node(a),nodeB=this.get_node(b);return nodeA.type===nodeB.type?this.get_text(a)>this.get_text(b)?1:-1:"index"===nodeA.type?-1:"index"===nodeB.type?1:"file"===nodeA.type?1:-1}})})})}function isFolder(key){return"/"===key.substr(-1)?!0:!1}function doesTreeNodeExist(id){return $("#tree").jstree("get_node",id)?!0:!1}function addNode(key,parent,text,title){var folder=isFolder(key),id=getTreeNodeId(key);parent=getTreeNodeId(parent);var node={id:id,parent:parent,text:text,type:folder?"folder":"file",li_attr:{"data-key":key},state:{opened:!0}};return"index"===text&&(node.type=text),title&&(node.a_attr={title:title}),doesTreeNodeExist(id)||$("#tree").jstree("create_node","#"+parent,node),node}function block(){$.blockUI({css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"},overlayCSS:{backgroundColor:"#000",opacity:0,cursor:"wait"}})}function unblock(){$.unblockUI()}function save(event){event.preventDefault();var $title=$("#entry-form-title"),$folder=$("#entry-form-folder"),$slug=$("#entry-form-slug"),$content=$("#entry-form-content"),title=$.trim($title.val()),folder=$("option:selected",$folder).data("folder"),slug=$.trim($slug.val()).toLowerCase(),content=$.trim($content.val());if(!title.length||title.length>64)return void alert("The title needs to be between 1 and 64 characters.");if(!/^([a-zA-Z0-9-_]){1,32}$/.test(slug))return void alert("The url slug must be at most 32 characters, and can only contain letters, numbers, dashes, underscores.");block();var callback=function(key,folder,slug,title){$("#main").data("key",key),addNode(key,folder,slug,title),$slug.attr("data-entry-form-slug",slug),$slug.data("entry-form-slug",slug),$slug.val(slug),$folder.attr("data-entry-form-folder",folder),$folder.data("entry-form-folder",folder),dodgercms.entry.upsert(key,title,content,SITE_BUCKET,SITE_ENDPOINT,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){unblock()})})},key="/"!==folder?folder+slug:slug,$folderData=$folder.data("entry-form-folder"),$slugData=$slug.data("entry-form-slug");if($slugData&&$folderData&&($folderData!==folder||$slugData!==slug)){var oldKey="/"!==$folderData?$folderData+$slugData:$slugData;dodgercms.entry.rename(oldKey,key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):($("#tree").jstree("delete_node","#"+getTreeNodeId(oldKey)),callback(key,folder,slug,title))})}else{var params={Bucket:DATA_BUCKET,Key:key,Body:content,ContentEncoding:"utf-8",ContentType:CONTENT_TYPE,Expires:0,CacheControl:"public, max-age=0, no-cache",Metadata:{title:title}};dodgercms.s3.putObject(params,function(err,data){callback(key,folder,slug,title)})}}function editEntry(key){dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){var body=data.Body.toString(),source=$("#edit-entry-template").html(),template=Handlebars.compile(source),modified=new Date(data.LastModified);dodgercms.s3.listObjects(DATA_BUCKET,function(err,list){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(list.Contents),slug=getSlug(key),selectedFolder=key.indexOf("/")>-1?key.substr(0,key.lastIndexOf("/")+1):"/",context={title:data.Metadata.title,modified:modified.toLocaleString(),key:key,folders:folders,selectedFolder:selectedFolder,slug:slug,content:body},html=template(context);$("#main").html(html)}})})}function clearEntry(key){key===$("#main").data("key")&&$("#main").empty().data("key",null)}function getTreeNodeId(key){if("/"===key)return"s3--root";var id,parts=key.replace(/\/\s*$/,"").split("/"),prefix="s3-",folderSuffix="-folder";return id=isFolder(key)?prefix+parts.join("-")+folderSuffix:prefix+parts.join("-")}function newEntry(folder){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(data.Contents),context={folders:folders,selectedFolder:folder?folder:null},source=$("#edit-entry-template").html(),template=Handlebars.compile(source),html=template(context);$("#main").html(html)}})}function getSlug(key){var parts=key.split("/");return parts.pop()}function getKeyContent(key,callback){dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){err?errorHandler(err):loadKeyContent(key,data)})}function loadKeyContent(key,content){var body=content.Body.toString(),source=$("#entry-template").html(),template=Handlebars.compile(source),modified=new Date(content.LastModified),context={title:content.Metadata.title,modified:modified.toLocaleString(),link:"",key:key,content:marked(body,markedOptions)},html=template(context);$("#main").html(html).data("key",key),$("#main .content-body pre code").each(function(i,block){hljs.highlightBlock(block)})}var DATA_BUCKET=localStorage.getItem("dodgercms-data-bucket"),ASSETS_BUCKET=localStorage.getItem("dodgercms-assets-bucket"),SITE_BUCKET=localStorage.getItem("dodgercms-site-bucket"),SITE_ENDPOINT=localStorage.getItem("dodgercms-site-endpoint"),CONTENT_TYPE="text/plain; charset=UTF-8",S3_ENDPOINT="s3.amazonaws.com",markedOptions={renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!0,highlight:function(code){return hljs.highlightAuto(code).value}};Handlebars.registerHelper("selected",function(option,value){return option===value?' selected="selected"':""}),Handlebars.registerHelper("raw-helper",function(options){return options.fn()}),$(document).on("click",".pure-button",function(){$(this).blur()}),s3init(!1),buildTree(),$(document).bind("keydown",function(event){event.ctrlKey&&83==event.which&&$("#entry-form").is(":visible")&&save(event)}),$(document).on("submit","#entry-form",save),$(document).on("click","#edit-entry",function(event){var key=$(this).data("key");"undefined"!=typeof key&&editEntry(key)}),$(document).on("click","#delete-entry",function(event){var key=$(this).data("key");"undefined"!=typeof key&&window.confirm("Are you sure?")&&dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){$("#tree").jstree("delete_node","#"+getTreeNodeId(key)),clearEntry(key)})})}),$(document).on("click","#close-entry",function(event){var key=$("#main").data("key");key&&"/"!==key?getKeyContent(key):clearEntry(key)}),$(document).on("change","#upload-image",function(event){var file=$("#upload-image")[0].files[0],content=$("#entry-form-content"),types=["image/png","image/jpg","image/jpeg","image/gif"];if(!file||types.indexOf(file.type)<0)return void alert("Only images can be uploaded.");if(!(content.length<=0)&&content.is(":visible")){var filename="images/"+file.name.replace(/\s|\\|\/|\(|\)/g,"-"),link="http://"+ASSETS_BUCKET+"."+S3_ENDPOINT+"/"+filename,params={Bucket:ASSETS_BUCKET,Key:filename,ContentType:file.type,Body:file};dodgercms.s3.upload(params,function(err,data){if(err)errorHandler(err);else{var cursorPosStart=content.prop("selectionStart"),cursorPosEnd=content.prop("selectionEnd"),v=content.val(),textBefore=v.substring(0,cursorPosStart),textAfter=v.substring(cursorPosEnd,v.length);content.val(textBefore+"!["+file.name+"]("+link+")"+textAfter)}})}}),$(document).on("click","#preview-entry",function(event){var preview=$("#content-preview"),content=$("#entry-form-content");if(preview.length>0)preview.remove(),content.show(),$(this).html('<i class="fa fa-search"></i>'),$(this).prop("title","Preview"),$("label[for=upload-image]").removeClass("none");else{var md=content.val(),html='<div id="content-preview">'+marked(md,markedOptions)+"</div>";content.hide(),$("#content-body-container").append(html),$("#content-preview pre code").each(function(i,block){hljs.highlightBlock(block)}),$(this).html('<i class="fa fa-pencil"></i>'),$(this).prop("title","Write"),$("label[for=upload-image]").addClass("none")}}),$("#new-entry").click(function(event){newEntry(null)})}),$(function(){"use strict";function autofill(){$("#login-form-access-key").val(localStorage.getItem("dodgercms-access-key-id")||""),$("#login-form-access-secret").val(localStorage.getItem("dodgercms-secret-access-key")||""),$("#login-form-data-bucket").val(localStorage.getItem("dodgercms-data-bucket")||""),$("#login-form-assets-bucket").val(localStorage.getItem("dodgercms-assets-bucket")||""),$("#login-form-site-bucket").val(localStorage.getItem("dodgercms-site-bucket")||"")}autofill(),$("#login-form").submit(function(event){event.preventDefault();var accessKey=$.trim($("#login-form-access-key").val()),accessSecret=$.trim($("#login-form-access-secret").val()),dataBucket=$.trim($("#login-form-data-bucket").val()),assetsBucket=$.trim($("#login-form-assets-bucket").val()),siteBucket=$.trim($("#login-form-site-bucket").val()),remember=$("#login-remember").is(":checked");if(""===accessKey||""===accessSecret||""===dataBucket||""===assetsBucket||""===siteBucket)return void alert("All fields are required.");var params={dataBucket:dataBucket,assetsBucket:assetsBucket,siteBucket:siteBucket,accessKey:accessKey,accessSecret:accessSecret,remember:remember};$.blockUI({css:{border:"none","font-size":"90%",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),dodgercms.auth.login(params,function(err,data){$.unblockUI(),err?alert(err):window.location.replace(location.protocol+"//"+location.host)})})});